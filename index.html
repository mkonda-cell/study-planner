<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Planner (Single HTML) – Improved</title>
  <style>
    :root{--pri:#4f46e5;--bg:#f7f7fb;--sidebar:360px}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;margin:0;background:var(--bg);color:#111;line-height:1.6}
    header{position:sticky;top:0;background:#fffcc;backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #e5e7eb}
    header .wrap{max-width:1280px;margin:auto;padding:12px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    main{max-width:1280px;margin:auto;padding:16px}
    .tabs button{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .tabs button.active{background:var(--pri);border-color:var(--pri);color:#fff}
    .grid{display:grid;gap:16px}
    /* Layout: sidebar + content */
    .grid-3{grid-template-columns:1fr}
    @media(min-width:1000px){.grid-3{grid-template-columns:var(--sidebar) 1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px}
    .muted{color:#6b7280}
    input,select,textarea{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;outline:none;font-size:16px;height:42px}
    textarea{height:auto}
    input:focus,select:focus,textarea:focus{border-color:var(--pri);box-shadow:0 0 0 3px rgba(79,70,229,.15)}
    label.small{font-size:12px;display:block;margin-top:2px;color:#6b7280}
    .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{background:#e11d48;border-color:#e11d48;color:#fff}
    .btn.ghost{background:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid #e5e7eb;vertical-align:top}
    .badge{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;font-size:12px}
    .badge.high{border-color:#fda4af;color:#9f1239}
    .badge.med{border-color:#fcd34d;color:#92400e}
    .badge.low{border-color:#d1d5db;color:#374151}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:var(--pri)}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    footer{max-width:1280px;margin:24px auto 40px;padding:0 16px;color:#6b7280;font-size:13px}
    .small{font-size:12px}

    /* Usability: sticky left, scrolly cert list, clearer form grid */
    .sidebar{position:sticky; top:76px; align-self:start; height:fit-content}
    .form-grid{display:grid;gap:8px;grid-template-columns:1fr}
    @media(min-width:640px){.form-grid{grid-template-columns:1fr 1fr}}
    .form-grid .col-span-2{grid-column:1 / -1}
    #cert-list{max-height:260px; overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1> Study Planner</h1>
      <div class="tabs flex">
        <button id="tab-plan" class="active">計画</button>
        <button id="tab-today">今日</button>
        <button id="tab-analytics">分析</button>
        <button id="tab-settings">設定</button>
      </div>
    </div>
  </header>
  <main>
    <div id="view-plan" class="grid grid-3">
      <!-- LEFT: sticky sidebar -->
      <div class="grid sidebar">
        <div class="card">
          <h2>資格・科目</h2>
          <div class="form-grid" aria-label="資格入力フォーム">
            <div class="col-span-2">
              <label for="cert-title" class="small muted">タイトル</label>
              <input id="cert-title" placeholder="例: 応用情報技術者" autocomplete="off"/>
            </div>
            <div>
              <label for="cert-week" class="small muted">週あたり(時間)</label>
              <input id="cert-week" type="number" step="0.5" placeholder="例: 6" />
            </div>
            <div>
              <label for="cert-exam" class="small muted">試験日</label>
              <input id="cert-exam" type="date" />
            </div>
          </div>
          <div class="flex" style="margin-top:8px">
            <button class="btn pri" id="btn-add-cert">追加</button>
          </div>
          <div id="cert-list" class="grid" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h2>要約</h2>
          <div class="row"><div class="muted">対象</div><div id="sum-target">-</div></div>
          <div class="row"><div class="muted">試験まで</div><div id="sum-days">-</div></div>
          <div class="row"><div class="muted">見積/実績/残</div><div id="sum-hours">-</div></div>
          <div class="progress" style="margin-top:6px"><i id="sum-progress" style="width:0%"></i></div>
        </div>
      </div>

      <!-- RIGHT: main content -->
      <div class="grid" style="grid-auto-rows:min-content">
        <div class="card">
          <h2>タスク</h2>
          <div class="grid" style="grid-template-columns:2fr 1fr 1fr 1fr;gap:8px">
            <input id="task-title" placeholder="タスク名 (例: 午前対策：アルゴリズム)" />
            <input id="task-est" type="number" step="0.5" placeholder="見積(h)" />
            <input id="task-due" type="date" />
            <select id="task-pri" aria-label="優先度">
              <option>Med</option>
              <option>High</option>
              <option>Low</option>
            </select>
          </div>
          <div class="flex" style="margin:8px 0">
            <button class="btn pri" id="btn-add-task">追加</button>
            <button class="btn" id="btn-template">テンプレ投入</button>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>タスク</th><th>優先</th><th>期限</th><th class="right">見積</th><th class="right">実績</th><th></th></tr></thead>
              <tbody id="task-tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="flex right">
            <button class="btn" id="btn-prev-week">← 前週</button>
            <input id="week-start" type="date" />
            <button class="btn" id="btn-next-week">次週 →</button>
            <button class="btn pri" id="btn-auto">自動割当</button>
          </div>
          <div id="week-grid" class="grid" style="grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px"></div>
        </div>
      </div>
    </div>

    <div id="view-today" class="grid" style="display:none">
      <div class="card">
        <h2 id="today-title">本日の予定</h2>
        <div id="today-list" class="grid"></div>
      </div>
      <div class="card">
        <h2>ポモドーロ</h2>
        <div class="flex" style="justify-content:space-between">
          <div>
            <div class="small muted">モード</div>
            <div id="pomo-mode" style="font-size:22px;font-weight:800">集中</div>
          </div>
          <div id="pomo-time" style="font-size:40px;font-family:monospace">25:00</div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn pri" id="pomo-toggle">開始</button>
          <button class="btn" id="pomo-reset">リセット</button>
          <button class="btn" id="pomo-switch">切替</button>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
          <div><div class="small muted">集中(分)</div><input id="pomo-focus" type="number" value="25"/></div>
          <div><div class="small muted">休憩(分)</div><input id="pomo-break" type="number" value="5"/></div>
        </div>
      </div>
      <div class="card">
        <h2>メモ</h2>
        <textarea rows="10" placeholder="気づき、弱点、次回やることなど…"></textarea>
      </div>
    </div>

    <div id="view-analytics" style="display:none" class="grid"></div>

    <div id="view-settings" style="display:none" class="grid grid-3">
      <div class="card">
        <h2>データのバックアップ</h2>
        <div class="flex"><button class="btn pri" id="btn-export">エクスポート</button><button class="btn" id="btn-import">インポート</button><input id="import-file" type="file" accept="application/json" style="display:none" /></div>
        <p class="small muted">エクスポートでJSONファイルがダウンロードされます。インポートは保存済みのJSONを選択してください。</p>
        <textarea id="export-text" rows="12" style="margin-top:8px;font-family:monospace;font-size:12px"></textarea>
      </div>
      <div class="card">
        <h2>ヘルプ</h2>
        <ul>
          <li>「計画」で資格とタスクを作成 → 自動割当で週間予定へ。</li>
          <li>「今日」でポモドーロを使い、終わったら「＋実績に反映」。</li>
          <li>「分析」で進捗と必要ペースを確認。</li>
          <li>データはブラウザ(localStorage)に保存されます。</li>
        </ul>
      </div>
    </div>
  </main>
  <footer>Made for GitHub Pages · Single HTML · Your data stays in your browser</footer>

  <script>
    // ===== Utilities =====
    const pad = n => String(n).padStart(2,'0');
    const today = () => new Date(new Date().toDateString());
    const toDateInput = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const fromDateInput = s => s ? new Date(s+'T00:00:00') : null;
    const daysBetween = (a,b) => Math.round((b-a)/86400000);
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const uid = ()=>Math.random().toString(36).slice(2,9);
    const weekday = d => ['月','火','水','木','金','土','日'][(d.getDay()+6)%7];

    // ===== State (localStorage) =====
    const DEFAULT = { certs: [], tasks: [], plan: {}, settings: {pomoF:25,pomoB:5} };
    const load = () => { try{ return JSON.parse(localStorage.getItem('sp_single_v1'))||DEFAULT }catch{ return DEFAULT } };
    const save = () => localStorage.setItem('sp_single_v1', JSON.stringify(state));
    let state = load();

    // ===== Tabs =====
    const views = { plan: qs('#view-plan'), today: qs('#view-today'), analytics: qs('#view-analytics'), settings: qs('#view-settings') };
    const tabs = { plan: qs('#tab-plan'), today: qs('#tab-today'), analytics: qs('#tab-analytics'), settings: qs('#tab-settings') };
    Object.entries(tabs).forEach(([k,btn])=> btn.onclick=()=>switchTab(k));
    function switchTab(key){
      Object.values(views).forEach(v=>v.style.display='none');
      Object.values(tabs).forEach(b=>b.classList.remove('active'));
      views[key].style.display='grid';
      tabs[key].classList.add('active');
      if(key==='plan'){ renderPlan(); const ti=qs('#cert-title'); if(ti){ ti.focus(); ti.select(); } }
      if(key==='today') renderToday();
      if(key==='analytics') renderAnalytics();
      if(key==='settings') renderSettings();
    }

    // ===== Plan View =====
    let selectedCertId = state.certs[0]?.id || null;

    // Init defaults
    qs('#cert-exam').value = toDateInput(new Date(Date.now()+1000*60*60*24*60));
    qs('#week-start').value = (function(){
      const d=today(); const wd=(d.getDay()+6)%7; d.setDate(d.getDate()-wd); return toDateInput(d);
    })();

    qs('#btn-add-cert').onclick = () => {
      const title = qs('#cert-title').value.trim();
      const weekly = Number(qs('#cert-week').value || 0);
      const exam = qs('#cert-exam').value;
      if(!title) return alert('タイトルを入力してください');
      const c = { id: uid(), title, weeklyGoalHours: weekly, examDate: exam };
      state.certs.push(c); selectedCertId = c.id; save(); renderPlan();
      qs('#cert-title').value='';
      qs('#cert-title').focus();
    };

    qs('#btn-add-task').onclick = () => {
      const cert = state.certs.find(c=>c.id===selectedCertId);
      if(!cert) return alert('資格を選択してください');
      const t = { id: uid(), certId: cert.id, title: qs('#task-title').value.trim(), estHours: Number(qs('#task-est').value||0), due: qs('#task-due').value, priority: qs('#task-pri').value, doneHours: 0 };
      if(!t.title) return alert('タスク名を入力してください');
      state.tasks.push(t); save(); renderPlan();
      qs('#task-title').value='';
    };

    qs('#btn-template').onclick = () => {
      const cert = state.certs.find(c=>c.id===selectedCertId); if(!cert) return;
      [
        { title:'シラバス確認', estHours:1 },
        { title:'過去問 1 回目', estHours:3 },
        { title:'過去問 2 回目', estHours:3 },
        { title:'弱点ノート作成', estHours:2 },
      ].forEach(t=> state.tasks.push({ id:uid(), certId:cert.id, doneHours:0, priority:'Med', due:'', ...t }));
      save(); renderPlan();
    };

    qs('#btn-prev-week').onclick = ()=> shiftWeek(-7);
    qs('#btn-next-week').onclick = ()=> shiftWeek(7);
    function shiftWeek(delta){ const d=fromDateInput(qs('#week-start').value); d.setDate(d.getDate()+delta); qs('#week-start').value=toDateInput(d); renderWeek(); }

    qs('#btn-auto').onclick = autoSchedule;

    function autoSchedule(){
      const cert = state.certs.find(c=>c.id===selectedCertId); if(!cert) return;
      const tasks = state.tasks.filter(t=>t.certId===cert.id);
      const totalEst = tasks.reduce((a,t)=>a+Number(t.estHours||0),0);
      const totalDone = tasks.reduce((a,t)=>a+Number(t.doneHours||0),0);
      let remaining = Math.max(0, totalEst-totalDone);
      const start = today(); const exam = fromDateInput(cert.examDate); if(!exam||exam<=start) return;
      const days = Math.max(1, daysBetween(start, exam));
      const perDay = Math.max(0.5, Math.min(3, (remaining/days)*1.2));
      const allDates = Array.from({length:days},(_,i)=>{ const d=new Date(start); d.setDate(d.getDate()+i); return toDateInput(d); });
      for(const date of allDates){ if(remaining<=0) break; const plan = state.plan[date]||{date,items:[]};
        const open = tasks.filter(t=>t.estHours-t.doneHours>0).sort(sortTasks);
        if(!open.length) break; const tgt = open[0];
        const amount = Math.min(perDay, tgt.estHours - tgt.doneHours);
        plan.items.push({ taskId:tgt.id, plannedHours: amount }); state.plan[date]=plan; remaining -= amount;
      }
      save(); renderWeek(); renderToday();
    }

    function renderPlan(){
      const list = qs('#cert-list'); list.innerHTML='';
      if(state.certs.length===0){ list.innerHTML='<p class="small muted">まだ資格がありません。上のフォームから追加してください。</p>'; }
      state.certs.forEach(c=>{
        const wrap = el('div'); wrap.className='flex'; wrap.style.justifyContent='space-between'; wrap.style.alignItems='center'; wrap.style.padding='8px'; wrap.style.border='1px solid #e5e7eb'; wrap.style.borderRadius='10px';
        const btn = el('button'); btn.className='btn ghost'; btn.textContent=c.title; btn.onclick=()=>{selectedCertId=c.id; renderPlan();};
        const meta = el('div'); meta.className='small muted'; meta.textContent=`試験日: ${c.examDate||'-'} / 週 ${c.weeklyGoalHours||0}h`;
        const left = el('div'); left.append(btn, el('div', {text:meta.textContent, class:'small muted'}));
        const edit = el('button'); edit.className='btn'; edit.textContent='編集'; edit.onclick=()=>{ const t=prompt('タイトル', c.title)||c.title; c.title=t; save(); renderPlan(); };
        const del = el('button'); del.className='btn danger'; del.textContent='削除'; del.onclick=()=>{ state.certs = state.certs.filter(x=>x.id!==c.id); state.tasks = state.tasks.filter(t=>t.certId!==c.id); if(selectedCertId===c.id) selectedCertId = state.certs[0]?.id||null; save(); renderPlan(); };
        const right = el('div'); right.className='flex'; right.append(edit,del);
        wrap.innerHTML='';
        const leftWrap = el('div'); leftWrap.append(btn, meta); wrap.append(leftWrap, right); list.append(wrap);
      });

      const cert = state.certs.find(c=>c.id===selectedCertId);
      const tbody = qs('#task-tbody'); tbody.innerHTML='';
      const tasks = state.tasks.filter(t=>cert&&t.certId===cert.id).sort(sortTasks);
      const totalEst = tasks.reduce((a,t)=>a+Number(t.estHours||0),0);
      const totalDone = tasks.reduce((a,t)=>a+Number(t.doneHours||0),0);
      const remaining = Math.max(0,totalEst-totalDone);

      tasks.forEach(t=>{
        const tr = el('tr');
        tr.append(td(`<div style="font-weight:600">${esc(t.title)}</div>`));
        tr.append(td(`<span class="badge ${badgeClass(t.priority)}">${t.priority}</span>`));
        tr.append(td(t.due||'-'));
        tr.append(tdRight(`${t.estHours}h`));
        const done = el('td'); done.style.textAlign='right';
        const inp = el('input'); inp.type='number'; inp.step='0.5'; inp.style.width='80px'; inp.value=t.doneHours||0; inp.onchange=()=>{ t.doneHours=Number(inp.value||0); save(); renderPlan(); };
        done.append(inp); tr.append(done);
        const ops = el('td'); const ebtn = el('button'); ebtn.className='btn'; ebtn.textContent='編集'; ebtn.onclick=()=>{ t.title=prompt('タスク名', t.title)||t.title; save(); renderPlan(); };
        const dbtn = el('button'); dbtn.className='btn danger'; dbtn.textContent='削除'; dbtn.onclick=()=>{ state.tasks=state.tasks.filter(x=>x.id!==t.id); save(); renderPlan(); };
        ops.append(ebtn, dbtn); tr.append(ops);
        tbody.append(tr);
      });

      qs('#sum-target').textContent = cert? cert.title : '-';
      const days = cert? daysBetween(today(), fromDateInput(cert.examDate||toDateInput(today()))) : 0;
      qs('#sum-days').textContent = cert? `${days} 日` : '-';
      qs('#sum-hours').textContent = `${totalEst}h / ${totalDone}h / ${remaining}h`;
      qs('#sum-progress').style.width = (totalEst? (totalDone/totalEst*100):0)+'%';

      renderWeek();
    }

    function renderWeek(){
      const grid = qs('#week-grid'); grid.innerHTML='';
      const start = fromDateInput(qs('#week-start').value);
      const dates = Array.from({length:7},(_,i)=>{ const d=new Date(start); d.setDate(d.getDate()+i); return toDateInput(d); });
      dates.forEach(dateStr=>{
        const card = el('div'); card.className='card';
        const head = el('div'); head.className='flex'; head.style.justifyContent='space-between';
        head.innerHTML = `<div><div class="small muted">${weekday(new Date(dateStr))}</div><div style="font-weight:700">${dateStr}</div></div>`;
        const add = el('button'); add.className='btn'; add.textContent='追加'; add.onclick=()=>addPlanItem(dateStr);
        head.append(add); card.append(head);
        const list = el('div'); const p = state.plan[dateStr]||{date:dateStr,items:[]};
        const total = p.items.reduce((a,it)=>a+Number(it.plannedHours||0),0);
        const badge = el('span'); badge.className='badge'; badge.textContent=total+'h'; badge.style.marginLeft='auto';
        head.append(badge);
        p.items.forEach((it,idx)=>{
          const box = el('div'); box.className='flex'; box.style.justifyContent='space-between'; box.style.border='1px solid #e5e7eb'; box.style.borderRadius='8px'; box.style.padding='6px 8px'; box.style.marginTop='6px';
          box.innerHTML = `<div><div style="font-weight:600">${esc(taskTitle(it.taskId))}</div><div class="small muted">${it.plannedHours}h</div></div>`;
          const rm = el('button'); rm.className='btn'; rm.textContent='削除'; rm.onclick=()=>{ const plan = state.plan[dateStr]||{date:dateStr,items:[]}; plan.items.splice(idx,1); state.plan[dateStr]=plan; save(); renderWeek(); };
          box.append(rm); list.append(box);
        });
        card.append(list); grid.append(card);
      });
    }

    function addPlanItem(dateStr){
      const open = state.tasks.filter(t=>t.estHours - (t.doneHours||0) > 0).sort(sortTasks);
      if(open.length===0) return alert('割り当て可能なタスクがありません');
      const name = prompt("タスク名を入力\n(ヒント: 未完了の先頭タスクを選ぶには空のままOK)") || open[0].title;
      const t = state.tasks.find(x=>x.title===name) || open[0];
      const h = Number(prompt('予定時間(h)', '1'))||1;
      const plan = state.plan[dateStr]||{date:dateStr,items:[]};
      plan.items.push({ taskId: t.id, plannedHours: h }); state.plan[dateStr]=plan; save(); renderWeek();
    }

    // ===== Today View =====
    function renderToday(){
      const d = toDateInput(today());
      qs('#today-title').textContent = `本日の予定 (${d})`;
      const p = state.plan[d]||{date:d,items:[]};
      const list = qs('#today-list'); list.innerHTML='';
      if(p.items.length===0){ list.innerHTML = '<p class="small muted">今日は予定がありません。計画タブで追加しましょう。</p>'; return; }
      p.items.forEach(it=>{
        const t = state.tasks.find(x=>x.id===it.taskId); if(!t) return;
        const row = el('div'); row.className='flex'; row.style.justifyContent='space-between'; row.style.border='1px solid #e5e7eb'; row.style.borderRadius='10px'; row.style.padding='8px';
        row.innerHTML = `<div><div style="font-weight:600">${esc(t.title)}</div><div class="small muted">予定: ${it.plannedHours}h / 実績: ${t.doneHours||0}h</div></div>`;
        const btn = el('button'); btn.className='btn'; btn.textContent='＋実績に反映'; btn.onclick=()=>{ t.doneHours = clamp((t.doneHours||0)+it.plannedHours, 0, t.estHours); save(); renderToday(); renderPlan(); };
        row.append(btn); list.append(row);
      });
    }

    // ===== Analytics View =====
    function renderAnalytics(){
      const wrap = qs('#view-analytics'); wrap.innerHTML='';
      if(state.certs.length===0){ wrap.innerHTML='<div class="card small muted">まずは資格を追加してください。</div>'; return; }
      state.certs.forEach(c=>{
        const list = state.tasks.filter(t=>t.certId===c.id);
        const est = list.reduce((a,t)=>a+Number(t.estHours||0),0);
        const done = list.reduce((a,t)=>a+Number(t.doneHours||0),0);
        const rem = Math.max(0, est-done);
        const daysLeft = daysBetween(today(), fromDateInput(c.examDate||toDateInput(today())));
        const dailyNeeded = daysLeft>0 ? rem/daysLeft : rem;
        const card = el('div'); card.className='card';
        card.innerHTML = `<h2>${esc(c.title)}</h2>
          <div class="row"><div class="muted">試験日</div><div>${c.examDate || '未設定'}</div></div>
          <div class="row"><div class="muted">見積/実績/残</div><div>${est}h / ${done}h / ${rem}h</div></div>
          <div class="progress"><i style="width:${est? (done/est*100):0}%"></i></div>
          <div class="row"><div class="muted">残り日数</div><div>${daysLeft} 日</div></div>
          <div class="row"><div class="muted">必要ペース</div><div>${dailyNeeded.toFixed(2)} h/日</div></div>
          <p class="small ${dailyNeeded*7 <= (c.weeklyGoalHours||0) ? '" style="color:#059669"' : '" style="color:#e11d48"'}">${dailyNeeded*7 <= (c.weeklyGoalHours||0) ? '現状の目標で間に合いそうです。' : '週目標を上げるか、スコープ調整が必要です。'}</p>`;
        wrap.append(card);
      });
    }

    // ===== Settings View =====
    qs('#btn-export').onclick = () => {
      const json = JSON.stringify(state, null, 2);
      qs('#export-text').value = json;
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`study-planner-backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    };
    qs('#btn-import').onclick = ()=> qs('#import-file').click();
    qs('#import-file').onchange = (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader(); fr.onload = ()=>{ try{ state = JSON.parse(fr.result); save(); alert('インポートしました'); switchTab('plan'); }catch{ alert('JSONの読み込みに失敗しました'); } }; fr.readAsText(file);
    };
    function renderSettings(){ qs('#pomo-focus').value = state.settings.pomoF||25; qs('#pomo-break').value = state.settings.pomoB||5; }

    // ===== Pomodoro =====
    let pomoMode='focus', running=false, seconds=(state.settings.pomoF||25)*60, timer=null;
    const setPomo = ()=>{ qs('#pomo-mode').textContent = (pomoMode==='focus')?'集中':'休憩'; const mm=String(Math.max(0,Math.floor(seconds/60))).padStart(2,'0'); const ss=String(Math.max(0,seconds%60)).padStart(2,'0'); qs('#pomo-time').textContent=`${mm}:${ss}` };
    setPomo();
    qs('#pomo-toggle').onclick = ()=>{ running=!running; qs('#pomo-toggle').textContent = running?'一時停止':'開始'; if(running){ timer=setInterval(()=>{ seconds--; if(seconds<0){ if(pomoMode==='focus'){ pomoMode='break'; seconds=(state.settings.pomoB||5)*60; } else { pomoMode='focus'; seconds=(state.settings.pomoF||25)*60; } setPomo(); } setPomo(); },1000);} else { clearInterval(timer); } };
    qs('#pomo-reset').onclick = ()=>{ running=false; clearInterval(timer); seconds=(pomoMode==='focus'?(state.settings.pomoF||25):(state.settings.pomoB||5))*60; qs('#pomo-toggle').textContent='開始'; setPomo(); };
    qs('#pomo-switch').onclick = ()=>{ pomoMode = (pomoMode==='focus')?'break':'focus'; seconds=(pomoMode==='focus'?(state.settings.pomoF||25):(state.settings.pomoB||5))*60; setPomo(); };
    qs('#pomo-focus').onchange = e=>{ state.settings.pomoF = Number(e.target.value||25); save(); if(pomoMode==='focus') seconds=state.settings.pomoF*60; setPomo(); };
    qs('#pomo-break').onchange = e=>{ state.settings.pomoB = Number(e.target.value||5); save(); if(pomoMode==='break') seconds=state.settings.pomoB*60; setPomo(); };

    // ===== Helpers =====
    function qs(sel){ return document.querySelector(sel); }
    function el(tag, opts){ const x=document.createElement(tag); if(opts?.text) x.textContent=opts.text; if(opts?.class) x.className=opts.class; return x; }
    function td(html){ const x=document.createElement('td'); x.innerHTML=html; return x; }
    function tdRight(text){ const x=document.createElement('td'); x.style.textAlign='right'; x.textContent=text; return x; }
    function esc(s){ return (s||'').replace(/[&<>"]+/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }
    function sortTasks(a,b){ const ps = prioScore(b.priority)-prioScore(a.priority); if(ps) return ps; const ad=new Date(a.due||'9999-12-31'); const bd=new Date(b.due||'9999-12-31'); if(ad-bd) return ad-bd; return (a.title||'').localeCompare(b.title||''); }
    function prioScore(p){ return p==='High'?2:p==='Med'?1:0 }
    function badgeClass(p){ return p==='High'?'high':'Med'?'med':'low' }
    function taskTitle(id){ return state.tasks.find(t=>t.id===id)?.title || ('Task:'+id) }

    // ===== Initial Render =====
    switchTab('plan');
  </script>
</body>
</html>
