<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Study Planner – Simple & Reliable (Single HTML)</title>
  <style>
    :root{
      --bg:#f7f8fb; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --pri:#6366f1; --pri-700:#4f46e5; --card:#ffffff; --radius:14px;
      --container:1000px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--ink);line-height:1.65}
    .wrap{max-width:var(--container);margin:auto;padding:16px}
    header{background:#fff;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:18px}
    .tabs{display:flex;gap:8px;margin:8px 0 0}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
    .tab.active{background:var(--pri);border-color:var(--pri);color:#fff}
    main{max-width:var(--container);margin:auto;padding:16px}
    .grid{display:grid;gap:16px}
    .layout{grid-template-columns:1fr}
    @media (min-width:960px){ .layout{grid-template-columns:360px 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    .card h2{margin:0 0 8px;font-size:16px}
    input,select,textarea{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(99,102,241,.18)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .row{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid var(--line);text-align:left;vertical-align:top}
    td.right{text-align:right}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
    .progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--pri),#8b5cf6)}
    #week{display:grid;gap:12px;grid-template-columns:repeat(7,1fr)}
    @media (max-width:960px){ #week{grid-auto-flow:column;grid-auto-columns:80%;overflow-x:auto} }
    .day{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    footer{max-width:var(--container);margin:24px auto 40px;padding:0 16px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex" style="justify-content:space-between">
        <h1>Study Planner</h1>
        <div class="tabs">
          <button id="t-plan" class="tab active" type="button">計画</button>
          <button id="t-today" class="tab" type="button">今日</button>
          <button id="t-analytics" class="tab" type="button">分析</button>
          <button id="t-settings" class="tab" type="button">設定</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- PLAN -->
    <section id="v-plan" class="grid layout">
      <div class="grid">
        <div class="card">
          <h2>資格・科目</h2>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
            <input id="cert-title" placeholder="例: 応用情報技術者">
            <input id="cert-week" type="number" step="0.5" placeholder="週あたり(時間)">
            <label class="muted" style="font-size:12px;align-self:end">試験日</label>
            <input id="cert-exam" type="date">
          </div>
          <div class="flex" style="margin-top:8px">
            <button id="add-cert" class="btn pri" type="button">追加</button>
          </div>
          <div id="cert-list" class="grid" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h2>要約</h2>
          <div class="row"><div class="muted">対象</div><div id="sum-target">-</div></div>
          <div class="row"><div class="muted">試験まで</div><div id="sum-days">-</div></div>
          <div class="row"><div class="muted">見積/実績/残</div><div id="sum-hours">-</div></div>
          <div class="progress" style="margin-top:6px"><i id="sum-progress" style="width:0%"></i></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>タスク</h2>
          <div class="grid" style="grid-template-columns:2fr 1fr 1fr 1fr;gap:8px">
            <input id="task-title" placeholder="タスク名">
            <input id="task-est" type="number" step="0.5" placeholder="見積(h)">
            <input id="task-due" type="date">
            <select id="task-pri"><option>Med</option><option>High</option><option>Low</option></select>
          </div>
          <div class="flex" style="margin:8px 0">
            <button id="add-task" class="btn pri" type="button">追加</button>
            <button id="add-template" class="btn" type="button">テンプレ投入</button>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>タスク</th><th>優先</th><th>期限</th><th class="right">見積</th><th class="right">実績</th><th></th></tr></thead>
              <tbody id="tasks"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="flex right">
            <button id="prev-week" class="btn" type="button">← 前週</button>
            <input id="week-start" type="date">
            <button id="next-week" class="btn" type="button">次週 →</button>
            <button id="auto" class="btn pri" type="button">自動割当</button>
          </div>
          <div id="week" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <!-- TODAY -->
    <section id="v-today" class="grid" style="display:none">
      <div class="card">
        <h2 id="today-title">本日の予定</h2>
        <div id="today-list" class="grid"></div>
      </div>
      <div class="card">
        <h2>ポモドーロ</h2>
        <div class="flex" style="justify-content:space-between">
          <div><div class="muted" style="font-size:12px">モード</div><div id="p-mode" style="font-weight:800">集中</div></div>
          <div id="p-time" style="font-family:monospace;font-size:36px">25:00</div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button id="p-toggle" class="btn pri" type="button">開始</button>
          <button id="p-reset" class="btn" type="button">リセット</button>
          <button id="p-switch" class="btn" type="button">切替</button>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div><div class="muted" style="font-size:12px">集中(分)</div><input id="p-focus" type="number" value="25"></div>
          <div><div class="muted" style="font-size:12px">休憩(分)</div><input id="p-break" type="number" value="5"></div>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="v-analytics" class="grid" style="display:none"></section>

    <!-- SETTINGS -->
    <section id="v-settings" class="grid" style="display:none">
      <div class="card">
        <h2>データのバックアップ</h2>
        <div class="flex"><button id="export" class="btn pri" type="button">エクスポート</button><button id="import" class="btn" type="button">インポート</button><input id="import-file" type="file" accept="application/json" style="display:none"></div>
        <textarea id="export-text" rows="12" style="margin-top:8px;font-family:monospace;font-size:12px"></textarea>
      </div>
    </section>
  </main>

  <footer class="wrap muted">Single HTML · ローカル保存（localStorage）</footer>

  <script>
  (function(){
    "use strict";

    // ---------- utils ----------
    const pad = n => String(n).padStart(2,"0");
    const today = () => new Date(new Date().toDateString());
    const toDateInput = d => \`\${d.getFullYear()}-\${pad(d.getMonth()+1)}-\${pad(d.getDate())}\`;
    const fromDateInput = s => s ? new Date(s+"T00:00:00") : null;
    const daysBetween = (a,b) => Math.round((b-a)/86400000);
    const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
    const uid = () => Math.random().toString(36).slice(2,9);
    const weekday = d => ["月","火","水","木","金","土","日"][(d.getDay()+6)%7];
    const esc = s => (s||"").replace(/[&<>"]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));

    // ---------- state ----------
    const DEFAULT = { certs:[], tasks:[], plan:{}, settings:{pomoF:25,pomoB:5} };
    let state;
    try{ state = JSON.parse(localStorage.getItem("sp_single_clean")) || DEFAULT; }catch{ state = DEFAULT; }
    const save = () => localStorage.setItem("sp_single_clean", JSON.stringify(state));

    // ---------- tab handling ----------
    const views = { plan: g("#v-plan"), today: g("#v-today"), analytics: g("#v-analytics"), settings: g("#v-settings") };
    const tabs  = { plan: g("#t-plan"), today: g("#t-today"), analytics: g("#t-analytics"), settings: g("#t-settings") };
    Object.entries(tabs).forEach(([k,btn]) => btn.addEventListener("click", () => show(k)));
    function show(key){
      Object.values(views).forEach(v => v.style.display="none");
      Object.values(tabs).forEach(b => b.classList.remove("active"));
      views[key].style.display = "grid";
      tabs[key].classList.add("active");
      if(key==="plan") renderPlan();
      if(key==="today") renderToday();
      if(key==="analytics") renderAnalytics();
      if(key==="settings") renderSettings();
    }

    // ---------- initial ----------
    let selectedCertId = state.certs[0]?.id || null;
    g("#cert-exam").value = toDateInput(new Date(Date.now()+1000*60*60*24*60));
    g("#week-start").value = (function(){ const d=today(); const wd=(d.getDay()+6)%7; d.setDate(d.getDate()-wd); return toDateInput(d) })();

    // ---------- certs ----------
    on("#add-cert","click", () => {
      const title = g("#cert-title").value.trim();
      const weekly = Number(g("#cert-week").value||0);
      const exam = g("#cert-exam").value;
      if(!title) return alert("タイトルを入力してください");
      const c = { id: uid(), title, weeklyGoalHours: weekly, examDate: exam };
      state.certs.push(c); selectedCertId = c.id; save(); renderPlan();
      g("#cert-title").value = "";
    });

    // ---------- tasks ----------
    on("#add-task","click", () => {
      const cert = state.certs.find(c=>c.id===selectedCertId);
      if(!cert) return alert("資格を選択してください");
      const t = {
        id: uid(), certId: cert.id,
        title: g("#task-title").value.trim(),
        estHours: Number(g("#task-est").value||0),
        due: g("#task-due").value,
        priority: g("#task-pri").value,
        doneHours: 0
      };
      if(!t.title) return alert("タスク名を入力してください");
      state.tasks.push(t); save(); renderPlan();
      g("#task-title").value = "";
    });

    on("#add-template","click", () => {
      const cert = state.certs.find(c=>c.id===selectedCertId); if(!cert) return;
      [
        {title:"シラバス確認", estHours:1},
        {title:"過去問 1 回目", estHours:3},
        {title:"過去問 2 回目", estHours:3},
        {title:"弱点ノート作成", estHours:2},
      ].forEach(t => state.tasks.push({ id:uid(), certId:cert.id, doneHours:0, priority:"Med", due:"", ...t }));
      save(); renderPlan();
    });

    // ---------- week controls ----------
    on("#prev-week","click", () => shiftWeek(-7));
    on("#next-week","click", () => shiftWeek(7));
    function shiftWeek(delta){
      const d = fromDateInput(g("#week-start").value);
      d.setDate(d.getDate()+delta);
      g("#week-start").value = toDateInput(d);
      renderWeek();
    }

    on("#auto","click", autoSchedule);
    function autoSchedule(){
      const cert = state.certs.find(c=>c.id===selectedCertId); if(!cert) return;
      const tasks = state.tasks.filter(t=>t.certId===cert.id);
      const totalEst = tasks.reduce((a,t)=>a+Number(t.estHours||0),0);
      const totalDone = tasks.reduce((a,t)=>a+Number(t.doneHours||0),0);
      let remaining = Math.max(0,totalEst-totalDone);
      const start = today(); const exam = fromDateInput(cert.examDate); if(!exam||exam<=start) return;
      const days = Math.max(1, daysBetween(start, exam));
      const perDay = Math.max(0.5, Math.min(3, (remaining/days)*1.2));
      const allDates = Array.from({length:days},(_,i)=>{ const d=new Date(start); d.setDate(d.getDate()+i); return toDateInput(d) });
      for(const date of allDates){
        if(remaining<=0) break;
        const plan = state.plan[date] || {date, items:[]};
        const open = tasks.filter(t=>t.estHours - t.doneHours > 0).sort(sortTasks);
        if(!open.length) break;
        const tgt = open[0];
        const amount = Math.min(perDay, tgt.estHours - tgt.doneHours);
        plan.items.push({ taskId:tgt.id, plannedHours: amount });
        state.plan[date] = plan;
        remaining -= amount;
      }
      save(); renderWeek(); renderToday();
    }

    // ---------- renderers ----------
    function renderPlan(){
      const list = g("#cert-list"); list.innerHTML="";
      if(state.certs.length===0) list.innerHTML = '<p class="muted" style="font-size:12px">まだ資格がありません。上のフォームから追加してください。</p>';

      state.certs.forEach(c => {
        const row = ce("div"); row.className="flex"; row.style.justifyContent="space-between"; row.style.border="1px solid var(--line)"; row.style.borderRadius="12px"; row.style.padding="8px";
        const left = ce("div");
        const pick = ce("button"); pick.className="btn"; pick.type="button"; pick.textContent = c.title; pick.onclick = ()=>{ selectedCertId = c.id; renderPlan(); };
        const meta = ce("div"); meta.className="muted"; meta.style.fontSize="12px"; meta.textContent = `試験日: ${c.examDate||"-"} / 週 ${c.weeklyGoalHours||0}h`;
        left.append(pick, meta);
        const right = ce("div"); right.className="flex";
        const edit = ce("button"); edit.className="btn"; edit.type="button"; edit.textContent="編集"; edit.onclick=()=>{ const t = prompt("タイトル", c.title) || c.title; c.title = t; save(); renderPlan(); };
        const del  = ce("button"); del.className="btn danger"; del.type="button"; del.textContent="削除"; del.onclick=()=>{ state.certs = state.certs.filter(x=>x.id!==c.id); state.tasks = state.tasks.filter(t=>t.certId!==c.id); if(selectedCertId===c.id) selectedCertId = state.certs[0]?.id||null; save(); renderPlan(); };
        right.append(edit, del);
        row.append(left, right);
        list.append(row);
      });

      const cert = state.certs.find(c=>c.id===selectedCertId);
      const tbody = g("#tasks"); tbody.innerHTML="";
      const tasks = state.tasks.filter(t=>cert && t.certId===cert.id).sort(sortTasks);
      const totalEst = tasks.reduce((a,t)=>a+Number(t.estHours||0),0);
      const totalDone= tasks.reduce((a,t)=>a+Number(t.doneHours||0),0);
      const remaining= Math.max(0,totalEst-totalDone);

      tasks.forEach(t => {
        const tr = ce("tr");
        tr.append(td(`<div style="font-weight:700">${esc(t.title)}</div>`));
        tr.append(td(`<span class="badge">${t.priority}</span>`));
        tr.append(td(t.due || "-"));
        tr.append(tdRight(`${t.estHours}h`));
        const done = ce("td"); done.className="right";
        const inp = ce("input"); inp.type="number"; inp.step="0.5"; inp.style.width="90px"; inp.value=t.doneHours||0; inp.onchange=()=>{ t.doneHours = Number(inp.value||0); save(); renderPlan(); };
        done.append(inp); tr.append(done);
        const ops = ce("td");
        const e = ce("button"); e.className="btn"; e.type="button"; e.textContent="編集"; e.onclick=()=>{ t.title = prompt("タスク名", t.title)||t.title; save(); renderPlan(); };
        const d = ce("button"); d.className="btn danger"; d.type="button"; d.textContent="削除"; d.onclick=()=>{ state.tasks = state.tasks.filter(x=>x.id!==t.id); save(); renderPlan(); };
        ops.append(e,d); tr.append(ops);
        tbody.append(tr);
      });

      g("#sum-target").textContent = cert ? cert.title : "-";
      const days = cert ? daysBetween(today(), fromDateInput(cert.examDate||toDateInput(today()))) : 0;
      g("#sum-days").textContent = cert ? `${days} 日` : "-";
      g("#sum-hours").textContent = `${totalEst}h / ${totalDone}h / ${remaining}h`;
      g("#sum-progress").style.width = (totalEst ? (totalDone/totalEst*100) : 0) + "%";

      renderWeek();
    }

    function renderWeek(){
      const wrap = g("#week"); wrap.innerHTML="";
      const start = fromDateInput(g("#week-start").value);
      const dates = Array.from({length:7},(_,i)=>{ const d=new Date(start); d.setDate(d.getDate()+i); return toDateInput(d) });
      dates.forEach(dateStr => {
        const card = ce("div"); card.className="day";
        const head = ce("div"); head.className="flex"; head.style.justifyContent="space-between";
        head.innerHTML = `<div><div class="muted" style="font-size:12px">${weekday(new Date(dateStr))}</div><div style="font-weight:800">${dateStr}</div></div>`;
        const add = ce("button"); add.className="btn"; add.type="button"; add.textContent="追加"; add.onclick=()=>addPlan(dateStr);
        head.append(add); card.append(head);
        const p = state.plan[dateStr] || {date:dateStr, items:[]};
        const list = ce("div");
        p.items.forEach((it,idx) => {
          const row = ce("div"); row.className="flex"; row.style.justifyContent="space-between"; row.style.border="1px solid var(--line)"; row.style.borderRadius="10px"; row.style.padding="6px 8px"; row.style.marginTop="6px";
          row.innerHTML = `<div><div style="font-weight:600">${esc(taskTitle(it.taskId))}</div><div class="muted" style="font-size:12px">${it.plannedHours}h</div></div>`;
          const rm = ce("button"); rm.className="btn"; rm.type="button"; rm.textContent="削除"; rm.onclick=()=>{ const plan = state.plan[dateStr]||{date:dateStr,items:[]}; plan.items.splice(idx,1); state.plan[dateStr]=plan; save(); renderWeek(); };
          row.append(rm); list.append(row);
        });
        card.append(list); wrap.append(card);
      });
    }

    function addPlan(dateStr){
      const open = state.tasks.filter(t=>t.estHours - (t.doneHours||0) > 0).sort(sortTasks);
      if(open.length===0) return alert("割り当て可能なタスクがありません");
      const name = prompt("タスク名を入力（空のままOKで先頭を選択）") || open[0].title;
      const t = state.tasks.find(x=>x.title===name) || open[0];
      const h = Number(prompt("予定時間(h)", "1")) || 1;
      const plan = state.plan[dateStr] || {date:dateStr, items:[]};
      plan.items.push({ taskId: t.id, plannedHours: h });
      state.plan[dateStr] = plan; save(); renderWeek();
    }

    function renderToday(){
      const d = toDateInput(today());
      g("#today-title").textContent = `本日の予定 (${d})`;
      const p = state.plan[d] || {date:d, items:[]};
      const list = g("#today-list"); list.innerHTML="";
      if(p.items.length===0){ list.innerHTML = '<p class="muted" style="font-size:12px">今日は予定がありません。計画タブで追加しましょう。</p>'; return; }
      p.items.forEach(it => {
        const t = state.tasks.find(x=>x.id===it.taskId); if(!t) return;
        const row = ce("div"); row.className="flex"; row.style.justifyContent="space-between"; row.style.border="1px solid var(--line)"; row.style.borderRadius="10px"; row.style.padding="8px";
        row.innerHTML = `<div><div style="font-weight:700">${esc(t.title)}</div><div class="muted" style="font-size:12px">予定: ${it.plannedHours}h / 実績: ${t.doneHours||0}h</div></div>`;
        const btn = ce("button"); btn.className="btn"; btn.type="button"; btn.textContent="＋実績に反映"; btn.onclick=()=>{ t.doneHours = clamp((t.doneHours||0) + it.plannedHours, 0, t.estHours); save(); renderToday(); renderPlan(); };
        row.append(btn); list.append(row);
      });
    }

    function renderAnalytics(){
      const wrap = g("#v-analytics"); wrap.innerHTML = "";
      if(state.certs.length===0){ wrap.innerHTML = '<div class="card"><p class="muted" style="font-size:12px">まずは資格を追加してください。</p></div>'; return; }
      state.certs.forEach(c => {
        const list = state.tasks.filter(t=>t.certId===c.id);
        const est = list.reduce((a,t)=>a+Number(t.estHours||0),0);
        const done= list.reduce((a,t)=>a+Number(t.doneHours||0),0);
        const rem = Math.max(0, est-done);
        const daysLeft = daysBetween(today(), fromDateInput(c.examDate||toDateInput(today())));
        const daily = daysLeft>0 ? rem/daysLeft : rem;
        const card = ce("div"); card.className="card";
        card.innerHTML = `<h2>${esc(c.title)}</h2>
          <div class="row"><div class="muted">試験日</div><div>${c.examDate || "未設定"}</div></div>
          <div class="row"><div class="muted">見積/実績/残</div><div>${est}h / ${done}h / ${rem}h</div></div>
          <div class="progress"><i style="width:${est?(done/est*100):0}%"></i></div>
          <div class="row"><div class="muted">残り日数</div><div>${daysLeft} 日</div></div>
          <div class="row"><div class="muted">必要ペース</div><div>${daily.toFixed(2)} h/日</div></div>
          <p class="muted" style="font-size:12px;${daily*7 <= (c.weeklyGoalHours||0) ? 'color:#059669' : 'color:#e11d48'}">${daily*7 <= (c.weeklyGoalHours||0) ? '現状の目標で間に合いそうです。' : '週目標を上げるか、スコープ調整が必要です。'}</p>`;
        wrap.append(card);
      });
    }

    // ---------- settings ----------
    on("#export","click", () => {
      const json = JSON.stringify(state, null, 2);
      g("#export-text").value = json;
      const blob = new Blob([json], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = ce("a"); a.href=url; a.download=`study-planner-backup-${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
    });
    on("#import","click", () => g("#import-file").click());
    g("#import-file").addEventListener("change", e => {
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = () => { try{ state = JSON.parse(fr.result); save(); alert("インポートしました"); show("plan"); } catch{ alert("JSONの読み込みに失敗しました"); } };
      fr.readAsText(file);
    });

    // ---------- pomodoro ----------
    let mode="focus", running=false, seconds=(state.settings.pomoF||25)*60, timer=null;
    const setP = () => {
      g("#p-mode").textContent = mode==="focus" ? "集中" : "休憩";
      const mm = String(Math.floor(Math.max(0,seconds)/60)).padStart(2,"0");
      const ss = String(Math.max(0,seconds)%60).padStart(2,"0");
      g("#p-time").textContent = `${mm}:${ss}`;
    };
    setP();

    on("#p-toggle","click", () => {
      running = !running; g("#p-toggle").textContent = running ? "一時停止" : "開始";
      if(running){
        timer = setInterval(() => {
          seconds--;
          if(seconds < 0){
            mode = mode==="focus" ? "break" : "focus";
            seconds = (mode==="focus" ? (state.settings.pomoF||25) : (state.settings.pomoB||5)) * 60;
          }
          setP();
        }, 1000);
      }else{
        clearInterval(timer);
      }
    });
    on("#p-reset","click", () => { running=false; clearInterval(timer); seconds=(mode==="focus"?(state.settings.pomoF||25):(state.settings.pomoB||5))*60; g("#p-toggle").textContent="開始"; setP(); });
    on("#p-switch","click", () => { mode = mode==="focus" ? "break" : "focus"; seconds=(mode==="focus"?(state.settings.pomoF||25):(state.settings.pomoB||5))*60; setP(); });
    on("#p-focus","change", e => { state.settings.pomoF = Number(e.target.value||25); save(); if(mode==="focus") seconds=state.settings.pomoF*60; setP(); });
    on("#p-break","change", e => { state.settings.pomoB = Number(e.target.value||5); save(); if(mode==="break") seconds=state.settings.pomoB*60; setP(); });

    // ---------- helpers ----------
    function g(sel){ return document.querySelector(sel); }
    function on(sel, ev, fn){ const el = g(sel); if(el) el.addEventListener(ev, fn); }
    function ce(tag){ return document.createElement(tag); }
    function td(html){ const x=ce("td"); x.innerHTML=html; return x; }
    function tdRight(text){ const x=ce("td"); x.className="right"; x.textContent=text; return x; }
    function sortTasks(a,b){
      const p = score(b.priority) - score(a.priority); if(p) return p;
      const ad=new Date(a.due||"9999-12-31"), bd=new Date(b.due||"9999-12-31"); if(ad-bd) return ad-bd;
      return (a.title||"").localeCompare(b.title||"");
    }
    const score = p => p==="High" ? 2 : p==="Med" ? 1 : 0;
    const taskTitle = id => state.tasks.find(t=>t.id===id)?.title || ("Task:"+id);

    // boot
    show("plan");
  })();
  </script>
</body>
</html>
